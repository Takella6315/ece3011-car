#include <Arduino.h>

/* ========== PIN DEFINITIONS ========== */
// IR sensors
const int PIN_LEFT   = 4;   // ADC1_CH4
const int PIN_CENTER = 2;   // ADC1_CH2
const int PIN_RIGHT  = 3;   // ADC1_CH3

// Motor driver (DRV8833)
const int IN1 = 5;    // Left motor input A
const int IN2 = 6;    // Left motor input B
const int IN3 = 21;   // Right motor input A
const int IN4 = 22;   // Right motor input B

// Start/Stop button and LED
#define BUTTON_PIN  15   // example GPIO for start/stop button
#define LED_PIN     4

/* ========== CONSTANTS ========== */
const int THRESH = 900;   // line sensor threshold
const int AVG_N  = 8;
const int BASE_SPEED = 180;   // forward speed
const int TURN_SPEED = 150;   // turning speed

/* ========== START/STOP VARIABLES ========== */
bool systemOn = false;
bool lastButtonState = HIGH;
unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 50;

/* ========== SENSOR READ ========== */
int readAvg(int pin) {
  long s = 0;
  for (int i = 0; i < AVG_N; ++i) s += analogRead(pin);
  return (int)(s / AVG_N);
}

/* ========== MOTOR CONTROL ========== */
void stopMotors() {
  analogWrite(IN1, 0); analogWrite(IN2, 0);
  analogWrite(IN3, 0); analogWrite(IN4, 0);
}

void moveForward() {
  analogWrite(IN1, BASE_SPEED); analogWrite(IN2, 0);
  analogWrite(IN3, BASE_SPEED); analogWrite(IN4, 0);
}

void turnLeft() {
  analogWrite(IN1, 0);          analogWrite(IN2, TURN_SPEED);  // left reverse
  analogWrite(IN3, TURN_SPEED); analogWrite(IN4, 0);           // right forward
}

void turnRight() {
  analogWrite(IN1, TURN_SPEED); analogWrite(IN2, 0);           // left forward
  analogWrite(IN3, 0);          analogWrite(IN4, TURN_SPEED);  // right reverse
}

/* ========== SETUP ========== */
void setup() {
  Serial.begin(115200);
  delay(300);
  analogReadResolution(12);

  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);
  pinMode(LED_PIN, OUTPUT);

  stopMotors();

  Serial.println("ESP32-C6 3-Sensor Line Follower Ready");
  Serial.println("Press button to start/stop the system.");
}

/* ========== MAIN LOOP ========== */
void loop() {
  // --- START/STOP BUTTON ---
  int buttonState = digitalRead(BUTTON_PIN);
  if (buttonState != lastButtonState) lastDebounceTime = millis();

  if ((millis() - lastDebounceTime) > debounceDelay) {
    if (buttonState == LOW && lastButtonState == HIGH) {
      systemOn = !systemOn;
      digitalWrite(LED_PIN, systemOn ? HIGH : LOW);
      Serial.println(systemOn ? "System ON" : "System OFF");
      if (!systemOn) stopMotors();  // immediately stop if turned off
    }
  }
  lastButtonState = buttonState;

  // --- LINE FOLLOWING LOGIC ---
  if (systemOn) {
    int vL = readAvg(PIN_LEFT);
    int vC = readAvg(PIN_CENTER);
    int vR = readAvg(PIN_RIGHT);

    bool L_black = (vL > THRESH);
    bool C_black = (vC > THRESH);
    bool R_black = (vR > THRESH);

    Serial.print("L="); Serial.print(vL); Serial.print(L_black ? "(B) " : "(w) ");
    Serial.print("C="); Serial.print(vC); Serial.print(C_black ? "(B) " : "(w) ");
    Serial.print("R="); Serial.print(vR); Serial.print(R_black ? "(B) " : "(w) ");
    Serial.print(" â†’ ");

    if (R_black && !L_black) {
      turnRight();
      Serial.println("RIGHT");
    } 
    else if (L_black && !R_black) {
      turnLeft();
      Serial.println("LEFT");
    } 
    else if (C_black) {
      moveForward();
      Serial.println("FORWARD");
    } 
    else {
      stopMotors();
      Serial.println("STOP");
    }
  }
  else {
    stopMotors();  // ensure motors stay stopped when system OFF
  }

  delay(50);
}

